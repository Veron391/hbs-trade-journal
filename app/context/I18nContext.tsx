"use client";

import React, { createContext, useContext, useMemo, useState, useEffect } from 'react';

type Lang = 'uz' | 'ru' | 'en';

type Dict = Record<string, string>;

const dictionaries: Record<Lang, Dict> = {
  en: {
    calendar: 'Calendar',
    journal: 'Journal',
    stats: 'Stats',
    macroNews: 'Macro News',
    totalPL: 'Total P/L',
    totalProfitLoss: 'Total Profit/Loss',
    riskRewardRatio: 'Risk/Reward Ratio',
    totalTrades: 'Total Trades',
    trades: 'Trades',
    assetsTraded: 'Assets Traded',
    tradeDetails: 'Trade Details',
    setupNotes: 'Entry Reason',
    tradeLink: 'Trade Link',
    winRate: 'Win Rate',
    customDate: 'Custom Date',
    language: 'Language',
    yourTrades: 'Your Trades',
    addNewTrade: 'Add New Trade',
    navigationBlocked: 'Navigation is blocked. Complete or cancel the form to navigate to other pages.',
    emptyTradesHint: 'No trades recorded yet. Add your first trade or import from your trading platform.',
    tradeType: 'Trade Type',
    selectType: 'Select Type',
    direction: 'Direction',
    entryDate: 'Entry Date',
    exitDate: 'Exit Date',
    entryPrice: 'Buy Price',
    exitPrice: 'Sell Price',
    quantity: 'Quantity',
    selectEntryDate: 'Select entry date',
    selectExitDate: 'Select exit date',
    tradingStatistics: 'Trading Statistics',
    performanceCharts: 'Performance Charts',
    detailedStatistics: 'Detailed Statistics',
    noTradesForPeriod: 'No trades found for the selected period.',
    total: 'Total',
    stock: 'Stock',
    crypto: 'Crypto',
    long: 'Long',
    short: 'Short',
    symbol: 'Ticker',
    type: 'Type',
    link: 'Link',
    actions: 'Actions',
    profitLoss: 'Profit & Loss',
    amount: 'Amount',
    percentage: 'Percentage',
    pending: 'Pending',
    deleteAll: 'DELETE ALL',
    deleteAllTradesTitle: 'Delete All Trades',
    deleteAllConfirm: 'Are you sure you want to delete {count} trades?',
    deleteAllWarning: 'This action cannot be undone!',
    yesDeleteAll: 'Yes, Delete All',
    cancel: 'Cancel',
    confirmDeleteOne: 'Are you sure you want to delete this trade?',
    risk: 'Risk %',
    tradeCalendar: 'Trade Calendar',
    winningTrades: 'Winning Trades',
    losingTrades: 'Losing Trades',
    loadingSummary: 'Loading summary...',
    loadingCalendarData: 'Loading calendar data...',
    january: 'January',
    february: 'February',
    march: 'March',
    april: 'April',
    may: 'May',
    june: 'June',
    july: 'July',
    august: 'August',
    september: 'September',
    october: 'October',
    november: 'November',
    december: 'December',
    monday: 'Mon',
    tuesday: 'Tue',
    wednesday: 'Wed',
    thursday: 'Thu',
    friday: 'Fri',
    saturday: 'Sat',
    sunday: 'Sun',
    trade: 'trade',
    trades: 'trades',
    noData: 'No Data',
    noTradesFound: 'No trades found for this date',
    loading: 'Loading...',
    performanceCharts: 'Performance Charts',
    avgWinningTrade: 'Avg. Winning Trade',
    avgLosingTrade: 'Avg. Losing Trade',
    avgHoldTime: 'Avg. Hold Time',
    days: 'days',
    allTime: 'All Time',
    last7Days: '1 Week',
    thisMonth: 'This Month',
    lastMonth: 'Last Month',
    last90Days: 'Last 90 Days',
    yearToDate: 'Year to Date',
    winLossRatio: 'Win/Loss Ratio',
    breakEven: 'Break Even',
    pnlPerTrade: 'P&L per Trade (Last 10)',
    tradeTypeDistribution: 'Trade Type Distribution',
    detailedStatistics: 'Detailed Statistics',
    profitability: 'Profitability',
    averageProfitLoss: 'Average Profit/Loss',
    largestProfit: 'Largest Profit',
    largestLoss: 'Largest Loss',
    sortinoRatio: 'Sortino Ratio',
    sharpeRatio: 'Sharpe Ratio',
    tradeAnalysis: 'Trade Analysis',
    totalTrades: 'Total Trades',
    breakEvenTrades: 'Break Even Trades',
    maxConsecutiveWins: 'Max Consecutive Wins',
    maxConsecutiveLosses: 'Max Consecutive Losses',
    averageHoldTimeAll: 'Average Hold Time (All)',
    averageHoldTimeWinners: 'Average Hold Time (Winners)',
    averageHoldTimeLosers: 'Average Hold Time (Losers)'
  },
  ru: {
    calendar: 'Календарь',
    journal: 'Журнал',
    stats: 'Статистика',
    macroNews: 'Макро новости',
    totalPL: 'Итог P/L',
    totalProfitLoss: 'Общая прибыль/убыток',
    riskRewardRatio: 'Риск/Доходность',
    totalTrades: 'Всего сделок',
    trades: 'Сделки',
    assetsTraded: 'Торгуемые активы',
    tradeDetails: 'Детали сделки',
    setupNotes: 'Причина входа',
    tradeLink: 'Ссылка на сделку',
    winRate: 'Процент побед',
    customDate: 'Выбор даты',
    language: 'Язык',
    yourTrades: 'Ваши сделки',
    addNewTrade: 'Добавить сделку',
    navigationBlocked: 'Навигация заблокирована. Завершите или отмените форму для перехода на другие страницы.',
    emptyTradesHint: 'Пока нет записей. Добавьте первую сделку или импортируйте с платформы.',
    tradeType: 'Тип сделки',
    selectType: 'Выберите тип',
    direction: 'Направление',
    entryDate: 'Дата входа',
    exitDate: 'Дата выхода',
    entryPrice: 'Цена покупки',
    exitPrice: 'Цена продажи',
    quantity: 'Количество',
    selectEntryDate: 'Выберите дату входа',
    selectExitDate: 'Выберите дату выхода',
    tradingStatistics: 'Торговая статистика',
    performanceCharts: 'Графики производительности',
    detailedStatistics: 'Детальная статистика',
    noTradesForPeriod: 'За выбранный период сделки не найдены.',
    total: 'Всего',
    stock: 'Акции',
    crypto: 'Крипто',
    long: 'Лонг',
    short: 'Шорт',
    symbol: 'Тикер',
    type: 'Тип',
    link: 'Ссылка',
    actions: 'Действия',
    profitLoss: 'Прибыль и убыток',
    amount: 'Сумма',
    percentage: 'Процент',
    pending: 'В ожидании',
    deleteAll: 'УДАЛИТЬ ВСЕ',
    deleteAllTradesTitle: 'Удалить все сделки',
    deleteAllConfirm: 'Вы уверены, что хотите удалить {count} сделок?',
    deleteAllWarning: 'Это действие нельзя отменить!',
    yesDeleteAll: 'Да, удалить все',
    cancel: 'Отмена',
    confirmDeleteOne: 'Вы уверены, что хотите удалить эту сделку?',
    risk: 'Риск %',
    tradeCalendar: 'Торговый календарь',
    winningTrades: 'Прибыльные сделки',
    losingTrades: 'Убыточные сделки',
    loadingSummary: 'Загрузка сводки...',
    loadingCalendarData: 'Загрузка данных календаря...',
    january: 'Январь',
    february: 'Февраль',
    march: 'Март',
    april: 'Апрель',
    may: 'Май',
    june: 'Июнь',
    july: 'Июль',
    august: 'Август',
    september: 'Сентябрь',
    october: 'Октябрь',
    november: 'Ноябрь',
    december: 'Декабрь',
    monday: 'Пн',
    tuesday: 'Вт',
    wednesday: 'Ср',
    thursday: 'Чт',
    friday: 'Пт',
    saturday: 'Сб',
    sunday: 'Вс',
    trade: 'сделка',
    trades: 'сделки',
    noData: 'Нет данных',
    noTradesFound: 'Сделки для этой даты не найдены',
    loading: 'Загрузка...',
    performanceCharts: 'Графики производительности',
    avgWinningTrade: 'Сред. прибыльная сделка',
    avgLosingTrade: 'Сред. убыточная сделка',
    avgHoldTime: 'Сред. время удержания',
    days: 'дней',
    allTime: 'Все время',
    last7Days: '1 неделя',
    thisMonth: 'Этот месяц',
    lastMonth: 'Прошлый месяц',
    last90Days: 'Последние 90 дней',
    yearToDate: 'С начала года',
    winLossRatio: 'Соотношение выигрыш/проигрыш',
    breakEven: 'Безубыточность',
    pnlPerTrade: 'P&L за сделку (последние 10)',
    tradeTypeDistribution: 'Распределение типов сделок',
    detailedStatistics: 'Детальная статистика',
    profitability: 'Прибыльность',
    averageProfitLoss: 'Средняя прибыль/убыток',
    largestProfit: 'Крупнейшая прибыль',
    largestLoss: 'Крупнейший убыток',
    sortinoRatio: 'Коэффициент Сортино',
    sharpeRatio: 'Коэффициент Шарпа',
    tradeAnalysis: 'Анализ сделок',
    totalTrades: 'Всего сделок',
    breakEvenTrades: 'Безубыточные сделки',
    maxConsecutiveWins: 'Макс. подряд выигрышей',
    maxConsecutiveLosses: 'Макс. подряд проигрышей',
    averageHoldTimeAll: 'Среднее время удержания (все)',
    averageHoldTimeWinners: 'Среднее время удержания (выигрыши)',
    averageHoldTimeLosers: 'Среднее время удержания (проигрыши)'
  },
  uz: {
    calendar: 'Kalendar',
    journal: 'Jurnal',
    stats: 'Statistika',
    macroNews: 'Makro yangiliklar',
    totalPL: 'Umumiy P/L',
    totalProfitLoss: 'Umumiy Foyda/Zarar',
    riskRewardRatio: 'Risk/Daromad nisbati',
    totalTrades: 'Jami savdolar',
    trades: 'Savdolar',
    assetsTraded: 'Savdo qilingan aktivlar',
    tradeDetails: 'Savdo tafsilotlari',
    setupNotes: 'Kirishga sabab',
    tradeLink: 'Savdo havolasi',
    winRate: 'G‘alaba foizi',
    customDate: 'Sana tanlash',
    language: 'Til',
    yourTrades: 'Savdolaringiz',
    addNewTrade: 'Yangi savdo qo\'shish',
    navigationBlocked: 'Navigatsiya bloklangan. Boshqa sahifalarga o\'tish uchun formani to\'ldiring yoki bekor qiling.',
    emptyTradesHint: 'Hozircha savdolar yo\'q. Birinchi savdoni qo\'shing yoki platformadan import qiling.',
    tradeType: 'Savdo turi',
    selectType: 'Turini tanlang',
    direction: 'Yo‘nalish',
    entryDate: 'Kirish sanasi',
    exitDate: 'Chiqish sanasi',
    entryPrice: 'Xarid narxi',
    exitPrice: 'Sotish narxi',
    quantity: 'Miqdor',
    selectEntryDate: 'Kirish sanasini tanlang',
    selectExitDate: 'Chiqish sanasini tanlang',
    tradingStatistics: 'Savdo statistikasi',
    performanceCharts: 'Natijaning grafiklari',
    detailedStatistics: 'Batafsil statistika',
    noTradesForPeriod: 'Tanlangan davr uchun bitimlar topilmadi.',
    total: 'Barchasi',
    stock: 'Aksiya',
    crypto: 'Kripto',
    long: 'Long',
    short: 'Short',
    symbol: 'Ticker',
    type: 'Turi',
    link: 'Havola',
    actions: 'Amallar',
    profitLoss: 'Foyda va zarar',
    amount: 'Miqdor',
    percentage: 'Foiz',
    pending: 'Kutilmoqda',
    deleteAll: 'HAMMASINI O\'CHIRISH',
    deleteAllTradesTitle: 'Barcha savdolarni o\'chirish',
    deleteAllConfirm: 'Haqiqatdan ham {count} ta savdolarni o\'chirmoqchimisiz?',
    deleteAllWarning: 'Bu amalni ortga qaytarib bo\'lmaydi!',
    yesDeleteAll: 'Ha, hammasini o\'chirish',
    cancel: 'Bekor qilish',
    confirmDeleteOne: 'Ushbu savdoni o\'chirishni tasdiqlaysizmi?',
    risk: 'Risk %',
    tradeCalendar: 'Savdo kalendari',
    winningTrades: 'Foydali savdolar',
    losingTrades: 'Zararli savdolar',
    loadingSummary: 'Statistika yuklanmoqda...',
    loadingCalendarData: 'Kalendar ma\'lumotlari yuklanmoqda...',
    january: 'yanvar',
    february: 'fevral',
    march: 'mart',
    april: 'aprel',
    may: 'may',
    june: 'iyun',
    july: 'iyul',
    august: 'avgust',
    september: 'sentabr',
    october: 'oktabr',
    november: 'noyabr',
    december: 'dekabr',
    monday: 'Dush',
    tuesday: 'Sesh',
    wednesday: 'Chor',
    thursday: 'Pay',
    friday: 'Jum',
    saturday: 'Shan',
    sunday: 'Yak',
    trade: 'savdo',
    trades: 'savdolar',
    noData: 'Ma\'lumot yo\'q',
    noTradesFound: 'Ushbu sana uchun savdolar topilmadi',
    loading: 'Yuklanmoqda...',
    performanceCharts: 'Natija grafiklari',
    avgWinningTrade: 'O\'rtacha daromadli savdolar',
    avgLosingTrade: 'O\'rtacha zararli savdolar',
    avgHoldTime: 'O\'rtacha savdo vaqti',
    days: 'kun',
    allTime: 'Barcha vaqt',
    last7Days: '1 hafta',
    thisMonth: 'Bu oy',
    lastMonth: 'O\'tgan oy',
    last90Days: 'So\'nggi 90 kun',
    yearToDate: 'Yil boshidan',
    winLossRatio: 'G\'alaba/Zarar nisbati',
    breakEven: 'Zararsiz savdolar',
    pnlPerTrade: 'Savdo bo\'yicha P&L (so\'nggi 10 ta)',
    tradeTypeDistribution: 'Savdolar turi',
    detailedStatistics: 'Batafsil statistika',
    profitability: 'Batafsil statistikalar',
    averageProfitLoss: 'O\'rtacha foyda/zarar',
    largestProfit: 'Eng katta foyda',
    largestLoss: 'Eng katta zarar',
    sortinoRatio: 'Sortino nisbati',
    sharpeRatio: 'Sharpe nisbati',
    tradeAnalysis: 'Savdo tahlili',
    totalTrades: 'Jami savdolar',
    breakEvenTrades: 'Zararsiz savdolar',
    maxConsecutiveWins: 'Maks. ketma-ket g\'alabalar',
    maxConsecutiveLosses: 'Maks. ketma-ket zararlar',
    averageHoldTimeAll: 'O\'rtacha ushlab turish vaqti (barchasi)',
    averageHoldTimeWinners: 'O\'rtacha ushlab turish vaqti (g\'alabalar)',
    averageHoldTimeLosers: 'O\'rtacha ushlab turish vaqti (zararlar)'
  }
};

interface I18nContextType {
  lang: Lang;
  t: (key: string) => string;
  setLang: (l: Lang) => void;
}

const I18nContext = createContext<I18nContextType | undefined>(undefined);

export function I18nProvider({ children }: { children: React.ReactNode }) {
  const [lang, setLang] = useState<Lang>(() => {
    // Prefer the last user-chosen language saved in localStorage
    if (typeof window !== 'undefined') {
      const saved = localStorage.getItem('lang') as Lang | null;
      if (saved && ['en','ru','uz'].includes(saved)) return saved;
    }
    // Fall back to cookie (possibly from URL-based middleware)
    if (typeof document !== 'undefined') {
      const cookie = document.cookie.split('; ').find(v => v.startsWith('lang='));
      const cookieLang = cookie?.split('=')[1] as Lang | undefined;
      if (cookieLang && ['en','ru','uz'].includes(cookieLang)) return cookieLang;
    }
    return 'en';
  });

  useEffect(() => {
    // Persist selection; cookie mirrors localStorage so middleware stays in sync
    try {
      if (typeof window !== 'undefined') localStorage.setItem('lang', lang);
      if (typeof document !== 'undefined') {
        document.cookie = `lang=${lang}; path=/; max-age=31536000; samesite=lax`;
      }
    } catch (_) {}
  }, [lang]);

  const value = useMemo<I18nContextType>(() => ({
    lang,
    setLang: (l: Lang) => {
      setLang(l);
      try {
        if (typeof document !== 'undefined') {
          // 1 year
          document.cookie = `lang=${l}; path=/; max-age=31536000; samesite=lax`;
        }
        if (typeof window !== 'undefined') {
          localStorage.setItem('lang', l);
        }
      } catch (_) {}
    },
    t: (key: string) => dictionaries[lang][key] ?? key,
  }), [lang]);

  return (
    <I18nContext.Provider value={value}>{children}</I18nContext.Provider>
  );
}

export function useI18n() {
  const ctx = useContext(I18nContext);
  if (!ctx) throw new Error('useI18n must be used within I18nProvider');
  return ctx;
}


